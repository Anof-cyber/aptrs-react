import { 
  useState, 
  useEffect
  } from 'react';
import { useParams } from 'react-router-dom';
import { ExclamationCircleIcon } from '@heroicons/react/24/outline';
import { useVulnerabilityColor } from '../lib/customHooks';
import { WithAuth } from "../lib/authutils";
import { ModalErrorMessage, StyleLabel } from '../lib/formstyles'

import { Vulnerability, Project, ProjectVulnerability, VulnerabilityInstance } from '../lib/data/definitions'
import { getVulnerability, 
        getProject, 
        getProjectVulnerability } from '../lib/data/api';

//function to break the vulnerabilitycvssvector into an object for form radio buttons
function parseStringToObject(input: string): Record<string, string | null> {
  const pairs = input.split('/').filter(Boolean); // Split string by '/' and remove empty segments
  const result: Record<string, string | null> = {};
  for (const pair of pairs) {
    const [key, value] = pair.split(':'); // Split key-value pairs by ':'
    result[key] = value !== undefined ? value : null;
  }
  return result;
}

//converts an object representation of vulnerabilitycvssvector and converts it to a string like  e.g. CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:N"


type CVSSReturn = {
  success?: boolean
  errorType?: string
  baseMetricScore?: string | number | undefined;
  baseSeverity?: string | number | undefined;
  environmentalMetricScore?: string | number | undefined;
  environmentalSeverity?: string | number | undefined;
  temporalMetricScore?: string | number | undefined;
  temporalSeverity?: string | number | undefined;
  vectorString?: string | number | undefined;
}
interface VulnerabilityViewProps {
  projectId?: number
}

function VulnerabilityView(props: VulnerabilityViewProps): JSX.Element {
  //calculator is loaded in the base index.html from https://www.first.org/cvss/calculator/cvsscalc31.js
  const calculate: ((vector: string | null | undefined) => CVSSReturn) | undefined = window?.CVSS31.calculateCVSSFromVector;
  const [project, setProject] = useState<Project | null>(null)
  console.log('props', props)
  const {id} = useParams()
  const { projectId } = props
  const [loading, setLoading] = useState(true)
  const [loadingError, setLoadingError] = useState(false)
  
  
  const [vuln, setVuln] = useState<Vulnerability | ProjectVulnerability>(null)
  
  let calculatedScore: CVSSReturn = {}
  useEffect(() => {
    const loadData = async () => {
      try {   
        let vData: Vulnerability | ProjectVulnerability
        if(projectId) {
          vData = await getProjectVulnerability(String(id)) as  ProjectVulnerability;
        } else {
          vData = await getVulnerability(String(id)) as  Vulnerability;
        }
        setVuln(vData);

        calculatedScore = calculate(vData.cvssvector)
        
      } catch (error) {
          //the api returns 404 if there are no instancess, which is not technically an error, 
        // it just means we haven't saved any instances
        if (typeof error === 'string' && !error.includes('404')) {
          console.error("Error fetching vulnerability data:", error);
          setLoadingError(true);    
        }
      } finally {
        setLoading(false);
      }
    }
    const loadProject = async () => {
      if (projectId) {
        setLoading(true);
        try {
          const projectData = await getProject(projectId) as Project;
          setProject(projectData as Project);
        } catch (error) {
          setLoadingError(true);
          // Handle error fetching data
        } finally {
          setLoading(false);
        }
      }
    }
    loadData();
    if(projectId) {
      loadProject();
    }
  }, []);
  
  //for display of severity
  const [scoreTextColor, setScoreTextColor]=useState('blue-500')
  const [scoreMeaning, setScoreMeaning]=useState('None')
  
  
  
  const heading = () =>{
    if(projectId){
      return "Project Vulnerablity"
    }
    return "Vulnerability"
  }
  if (loadingError) return <ModalErrorMessage message={"Error loading vulnerability"} />
  if (loading) return <div>Loading...</div>
  return (
    <div  className="w-[840px] flex-1 rounded-lg min-h-[800px] border-black relative">
      <h1 className="mb-3 text-2xl">
          {heading()}
      </h1>
      
      {project && 
        <p className="mb-4">Project: {project.name}</p>
      }
       
       
        <div className="w-full mb-4">
          <div className="relative">
            <label 
              htmlFor="vulnerabilityname"
              className={StyleLabel}>
              Name
            </label>
              {vuln.vulnerabilityname}
          </div>
          <div className="relative">
            <label 
              htmlFor="vulnerabilityseverity"
              className='mb-1 mt-5 block text-sm font-medium text-gray-900'>
              Severity
            </label>
            {scoreMeaning ? <span className={`text-[${scoreTextColor}]`}>{scoreMeaning}</span> : "Use calculator below"}
          </div>
          <div className="relative">
            <label 
              htmlFor="vulnerabilitydescription"
              className='mb-1 mt-5 block text-sm font-medium text-gray-900'>
              Description
            </label>
            {vuln.vulnerabilitydescription}
                
          </div>
          <div className="relative">
            <label 
              htmlFor="vulnerabilitysolution"
              className='mb-1 mt-5 block text-sm font-medium text-gray-900'>
              Solution
            </label>
            {vuln.vulnerabilitysolution}
                
            
          </div>
          <div className="relative">
            <label 
              htmlFor="vulnerabilitylink"
              className='mb-1 mt-5 block text-sm font-medium text-gray-900'>
              Links to more information
            </label>
            
                
          </div>
          
        </div>
            <div className='mb-4'>
              
              Score: <span className={`text-[${scoreTextColor}]`}>
                {calculatedScore?.baseMetricScore} ({scoreMeaning})
              </span>
            </div>
        
        
        
        
        
      
    </div>
  );
}


export default WithAuth(VulnerabilityView);
