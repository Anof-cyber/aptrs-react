import { useState, useEffect } from 'react';
import { useParams, Link } from 'react-router-dom';
import { currentUserCan } from "../lib/utilities";
import { useVulnerabilityColor } from '../lib/customHooks';
import { WithAuth } from "../lib/authutils";
import { ModalErrorMessage, StyleLabel } from '../lib/formstyles'
import { FormSkeleton } from '../components/skeletons'

import { Vulnerability, Project, ProjectVulnerability, VulnerabilityInstance } from '../lib/data/definitions'
import { getVulnerability, 
        getProject, 
        getProjectVulnerability } from '../lib/data/api';

//function to break the vulnerabilitycvssvector into an object for form radio buttons
type CVSSReturn = {
  success?: boolean
  errorType?: string
  baseMetricScore?: string | number | undefined;
  baseSeverity?: string | number | undefined;
  environmentalMetricScore?: string | number | undefined;
  environmentalSeverity?: string | number | undefined;
  temporalMetricScore?: string | number | undefined;
  temporalSeverity?: string | number | undefined;
  vectorString?: string | number | undefined;
}
interface VulnerabilityViewProps {
  projectId?: number
}

function VulnerabilityView(props: VulnerabilityViewProps): JSX.Element {
  //calculator is loaded in the base index.html from https://www.first.org/cvss/calculator/cvsscalc31.js
  const calculate: ((vector: string | null | undefined) => CVSSReturn) | undefined = window?.CVSS31.calculateCVSSFromVector;
  const [project, setProject] = useState<Project | null>(null)
  console.log('props', props)
  const {id} = useParams()
  const { projectId } = props
  const [loading, setLoading] = useState(true)
  const [loadingError, setLoadingError] = useState(false)
  const [meaning, setMeaning] = useState('None')
  const [color, setColor] = useState('blue-500')
  const [vuln, setVuln] = useState<Vulnerability | ProjectVulnerability>(null)
  
  let calculatedScore: CVSSReturn = {}
  useEffect(() => {
    const loadData = async () => {
      try {   
        let vData: Vulnerability | ProjectVulnerability
        if(projectId) {
          vData = await getProjectVulnerability(String(id)) as  ProjectVulnerability;
        } else {
          vData = await getVulnerability(String(id)) as  Vulnerability;
        }
        setVuln(vData);
        calculatedScore = calculate(vData.cvssvector)
        setScoreMeaning(vData.vulnerabilityseverity)
        const [_meaning, _color] = useVulnerabilityColor(vData.vulnerabilityseverity as string)
        setMeaning(_meaning)
        setColor(_color)
        
      } catch (error) {
          //the api returns 404 if there are no instancess, which is not technically an error, 
        // it just means we haven't saved any instances
        if (typeof error === 'string' && !error.includes('404')) {
          console.error("Error fetching vulnerability data:", error);
          setLoadingError(true);    
        }
      } finally {
        setLoading(false);
      }
    }
    const loadProject = async () => {
      if (projectId) {
        setLoading(true);
        try {
          const projectData = await getProject(projectId) as Project;
          setProject(projectData as Project);
        } catch (error) {
          setLoadingError(true);
          // Handle error fetching data
        } finally {
          setLoading(false);
        }
      }
    }
    loadData();
    if(projectId) {
      loadProject();
    }
  }, []);
  
  //for display of severity
  const [scoreTextColor, setScoreTextColor]=useState('blue-500')
  const [scoreMeaning, setScoreMeaning]=useState('None')
  
  
  
  const heading = projectId ? "Project Vulnerablity" : "Vulnerability"
    
  if (loadingError) return <ModalErrorMessage message={"Error loading vulnerability"} />
  if(loading) return <FormSkeleton numInputs={6} className='max-w-lg'/>
  
  return (
    <div  className="w-[840px] flex-1 rounded-lg min-h-[800px] border-black relative">
      
      <h1 className="mb-3 text-2xl">
          {heading}
      </h1>
      {currentUserCan('Manage Vulnerability Data') && (
        <Link className='text-primary underline' to={`/vulnerabilities/${vuln.id}/edit`}>edit</Link>
      )}
      {project && 
        <p className="mb-4">Project: {project.name}</p>
      }
       
       
        <div className="w-full">
          <div className="relative mb-4">
            <label 
              htmlFor="vulnerabilityname"
              className={StyleLabel}>
              Name
            </label>
              {vuln.vulnerabilityname}
          </div>
          <div className='mb-4'>
            Score: <span className={`text-[${color}]`}>{vuln.cvssscore}
              {calculatedScore?.baseMetricScore} ({meaning})
            </span>
          </div>
         
          <div className="relative">
            <label 
              htmlFor="vulnerabilitydescription"
              className='mb-1 mt-5 block text-sm font-medium text-gray-900'>
              Description
            </label>
            <div dangerouslySetInnerHTML={{ __html: vuln.vulnerabilitydescription }} />
                
          </div>
          
          <div className="relative">
            <label 
              htmlFor="vulnerabilitysolution"
              className='mb-1 mt-5 block text-sm font-medium text-gray-900'>
              Solution
            </label>
            <div className='mt-2'>
            {vuln.vulnerabilitysolution ?
              <div dangerouslySetInnerHTML={{ __html: vuln.vulnerabilitysolution }} />
              :
              <div>
                No solution provided
              </div>
            }
            </div>
                
            
          </div>
          {vuln.vulnerabilityreferlnk &&
          <div className="relative">
            <label 
              htmlFor="vulnerabilitylink"
              className='mb-1 mt-5 block text-sm font-medium text-gray-900'>
              Links to more information
            </label>
            <div>
              {vuln.vulnerabilityreferlnk}
            </div>
            
                
          </div>
          }
        </div>
            
        
        
        
        
        
      
    </div>
  );
}


export default WithAuth(VulnerabilityView);
